<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV Live Desa</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet JS (Peta) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- HLS.js (Video Player) -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

    <style>
        /* Memastikan peta memenuhi seluruh tinggi layar */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
        #map {
            width: 100%;
            height: calc(100vh - 64px); /* Tinggi viewport dikurangi tinggi header */
            z-index: 10;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 8px;
        }
        /* Style untuk modal/popup video */
        #videoModal.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    
    <!-- Header -->
    <header class="bg-white shadow-md h-16 flex items-center justify-between px-6 z-20 relative">
        <div class="flex items-center space-x-4">
            <img src="https://cdn.jsdelivr.net/gh/karanggetaskeren-pisan/aset-website/Logo%20Indramayu.png" alt="Logo Desa" class="h-10">
            <h1 class="text-xl font-bold text-gray-800">CCTV Live Desa</h1>
        </div>
        <div class="text-sm text-gray-600">
            Pantau sudut desa secara langsung
        </div>
    </header>

    <!-- Kontainer Peta -->
    <main id="map"></main>

    <!-- Modal untuk Video Player -->
    <div id="videoModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-2xl w-full max-w-4xl max-h-[90vh] flex flex-col">
            <!-- Header Modal -->
            <div class="flex justify-between items-center p-4 border-b">
                <h2 id="videoTitle" class="text-lg font-semibold text-gray-900">Memuat CCTV...</h2>
                <button id="closeModal" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <!-- Konten Video -->
            <div class="p-2 bg-black flex-grow flex items-center justify-center">
                 <video id="cctvVideo" class="max-w-full max-h-[75vh]" controls autoplay muted playsinline></video>
            </div>
        </div>
    </div>

    <script>
        // ===================================================================================
        // PENTING: SESUAIKAN DATA DI BAWAH INI
        // ===================================================================================

        // 1. Ganti dengan Alamat IP Publik Statis Anda
        const PUBLIC_IP_ADDRESS = "160.19.18.67"; 

        // 2. Ganti dengan Latitude dan Longitude pusat desa Anda
        const initialMapCoordinates = [-6.506855504979234, 108.31230647302876]; // Contoh: Koordinat Indramayu
        const initialMapZoom = 14;

        // 3. Isi data untuk setiap CCTV
        const cctvData = [
            {
                name: "CCTV Balai Desa",
                coords: [-6.5075116720361965, 108.31241459007428], // Ganti dengan koordinat CCTV 1
                streamName: "cctv1" // Nama path yang SAMA dengan di mediamtx.yml
            },
            {
                name: "SMP Islam Baitush Sholih",
                coords: [-6.504661591259149, 108.3095382606473], // Ganti dengan koordinat CCTV 2
                streamName: "cctv2"
            },
            {
                name: "Warung Ibu Erti",
                coords: [-6.512528004200336, 108.3162842249336], // Ganti dengan koordinat CCTV 3
                streamName: "cctv3"
            },
            {
                name: "Jalan Karanganyar",
                coords: [-6.517313319329945, 108.32002697875079], // Ganti dengan koordinat CCTV 4
                streamName: "cctv4"
            }
        ];

        // ===================================================================================
        // BAGIAN KODE APLIKASI (Tidak perlu diubah jika tidak mengerti)
        // ===================================================================================

        // Inisialisasi Peta
        const map = L.map('map').setView(initialMapCoordinates, initialMapZoom);

        // Tambahkan layer peta (dari OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: 'Â© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        // Buat custom icon untuk CCTV
        const cctvIcon = L.icon({
            iconUrl: 'https://img.icons8.com/plasticine/100/000000/security-camera.png',
            iconSize: [40, 40], // ukuran ikon
            iconAnchor: [20, 40], // titik anchor
            popupAnchor: [0, -40] // titik popup
        });
        
        // Variabel global untuk HLS.js
        let hls;

        // Ambil elemen-elemen Modal
        const videoModal = document.getElementById('videoModal');
        const videoTitle = document.getElementById('videoTitle');
        const cctvVideo = document.getElementById('cctvVideo');
        const closeModalBtn = document.getElementById('closeModal');

        // Fungsi untuk menampilkan stream
        function showCctvStream(name, streamName) {
            videoTitle.textContent = name;
            videoModal.classList.remove('hidden');
            
            const videoSrc = `http://${PUBLIC_IP_ADDRESS}:8888/${streamName}/index.m3u8`;

            if (Hls.isSupported()) {
                if(hls) hls.destroy(); // Hancurkan instance lama jika ada
                hls = new Hls();
                hls.loadSource(videoSrc);
                hls.attachMedia(cctvVideo);
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    cctvVideo.play();
                });
            } else if (cctvVideo.canPlayType('application/vnd.apple.mpegurl')) {
                // Untuk browser yang mendukung HLS secara native (seperti Safari)
                cctvVideo.src = videoSrc;
                cctvVideo.addEventListener('loadedmetadata', function() {
                    cctvVideo.play();
                });
            }
        }

        // Fungsi untuk menutup modal
        function closeModal() {
            videoModal.classList.add('hidden');
            if (hls) {
                hls.destroy(); // Hentikan streaming dan hapus instance
            }
            cctvVideo.pause();
            cctvVideo.src = ""; // Kosongkan sumber video
        }

        // Tambahkan event listener untuk tombol tutup
        closeModalBtn.addEventListener('click', closeModal);

        // Tambahkan marker untuk setiap CCTV ke peta
        cctvData.forEach(cctv => {
            const marker = L.marker(cctv.coords, { icon: cctvIcon }).addTo(map);
            
            // Tampilkan nama saat di-hover
            marker.bindTooltip(cctv.name, {
                permanent: false, 
                direction: 'top',
                offset: [0, -40]
            });

            // Buka modal saat di-klik
            marker.on('click', () => {
                showCctvStream(cctv.name, cctv.streamName);
            });
        });

    </script>
</body>
</html>

